#!/bin/bash
# OpenClaw CLI Wrapper - Working Device Approval

set -e

COMPOSE_FILE="$HOME/AI-Project/openclaw-project/docker/docker-compose.yml"
ENV_FILE="$HOME/AI-Project/openclaw-project/docker/.env"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Load environment
if [ -f "$ENV_FILE" ]; then
    set -a
    source "$ENV_FILE"
    set +a
fi

# Verify token is set
if [ -z "$OPENCLAW_GATEWAY_TOKEN" ]; then
    echo -e "${RED}Error: OPENCLAW_GATEWAY_TOKEN not set in $ENV_FILE${NC}"
    echo "Generate one with: openssl rand -hex 32"
    exit 1
fi

check_gateway() {
    if ! docker ps --format '{{.Names}}' | grep -q "openclaw-gateway"; then
        echo -e "${YELLOW}Starting OpenClaw gateway...${NC}"
        docker compose -f "$COMPOSE_FILE" up -d openclaw-gateway
        sleep 5
    fi
    
    retries=0
    while ! curl -s http://localhost:18789 > /dev/null 2>&1; do
        retries=$((retries + 1))
        if [ $retries -gt 10 ]; then
            echo -e "${RED}Gateway failed to start${NC}"
            docker compose -f "$COMPOSE_FILE" logs --tail=20 openclaw-gateway
            exit 1
        fi
        echo -e "${YELLOW}Waiting for gateway... ($retries/10)${NC}"
        sleep 2
    done
}

ensure_cli() {
    if ! docker ps | grep -q "openclaw-cli"; then
        docker compose -f "$COMPOSE_FILE" run -d --name openclaw-cli --entrypoint "tail -f /dev/null" openclaw-cli
        sleep 2
    fi
}

case "${1:-}" in
    "start")
        echo -e "${YELLOW}Checking for OpenClaw updates...${NC}"
        docker compose -f "$COMPOSE_FILE" pull openclaw-gateway
        docker compose -f "$COMPOSE_FILE" pull openclaw-cli
        echo -e "${GREEN}✓ Images updated (or already latest)${NC}"
        echo ""
        echo -e "${GREEN}Starting OpenClaw services...${NC}"
        docker compose -f "$COMPOSE_FILE" up -d openclaw-gateway
        echo -e "${GREEN}✓ Gateway running${NC}"
        echo -e "${BLUE}  WebSocket: ws://localhost:18789${NC}"
        echo -e "${BLUE}  Control UI: http://localhost:18789${NC}"
        echo ""
        echo -e "${YELLOW}Available agents:${NC}"
        echo "  claw agent -m 'hello' --agent kimi"
        echo "  claw agent -m 'hello' --agent minimax"
        echo "  claw agent -m 'hello' --agent gpt-oss"
        ;;
    "stop")
        echo -e "${YELLOW}Stopping OpenClaw services...${NC}"
        if docker ps | grep -q "openclaw-cli"; then
            docker stop openclaw-cli || true
            docker rm openclaw-cli || true
        fi
        docker compose -f "$COMPOSE_FILE" down
        echo -e "${GREEN}✓ All services stopped${NC}"
        ;;
    
    "restart")
        docker compose -f "$COMPOSE_FILE" restart openclaw-gateway
        echo -e "${GREEN}✓ Gateway restarted${NC}"
        ;;
    
    "status")
        docker compose -f "$COMPOSE_FILE" ps
        ;;
    
    "logs")
        docker compose -f "$COMPOSE_FILE" logs -f openclaw-gateway
        ;;
    
    "shell"|"cli"|"")
        check_gateway
        ensure_cli
        echo -e "${GREEN}Attaching to OpenClaw CLI...${NC}"
        docker exec -it openclaw-cli bash -c "
            export OPENCLAW_GATEWAY_URL=http://openclaw-gateway:18789
            export OPENCLAW_GATEWAY_TOKEN=$OPENCLAW_GATEWAY_TOKEN
            echo -e '${GREEN}=== OpenClaw CLI ===${NC}'
            echo 'Gateway: http://openclaw-gateway:18789'
            echo 'Token: ${OPENCLAW_GATEWAY_TOKEN:0:8}...'
            echo ''
            echo 'Commands:'
            echo '  node dist/index.js status --url ws://openclaw-gateway:18789 --token \\\$OPENCLAW_GATEWAY_TOKEN'
            echo '  node dist/index.js agent -p \"Hello\" --url ws://openclaw-gateway:18789 --token \\\$OPENCLAW_GATEWAY_TOKEN'
            echo ''
            bash
        "
        ;;

    "agent")
        shift
        check_gateway
        
        # Parse arguments
        MESSAGE=""
        MODEL=""
        AGENT=""
        while [[ $# -gt 0 ]]; do
            case $1 in
                -m|--message)
                    MESSAGE="$2"
                    shift 2
                    ;;
                --model)
                    MODEL="$2"
                    shift 2
                    ;;
                --agent)
                    AGENT="$2"
                    shift 2
                    ;;
                *)
                    if [ -z "$MESSAGE" ]; then
                        MESSAGE="$1"
                    fi
                    shift
                    ;;
            esac
        done
        
        if [ -z "$MESSAGE" ]; then
            echo -e "${RED}Error: Message required${NC}"
            echo "Usage: claw agent -m \"your message\" [--agent AGENT_ID] [--model MODEL]"
            echo ""
            echo "Available agents:"
            echo "  qwen-14b, qwen-7b-q4, qwen-7b, phi3, deepseek"
            exit 1
        fi
        
        # Default to qwen-14b if no agent specified
        if [ -z "$AGENT" ]; then
            AGENT="qwen-14b"
            echo -e "${YELLOW}Using default agent: $AGENT${NC}"
        fi
        
        # Get current model to warn if it's slow
        CURRENT_MODEL=$(docker exec \
            openclaw-gateway \
            bash -c 'export OPENCLAW_GATEWAY_URL=http://localhost:18789 && export OPENCLAW_GATEWAY_TOKEN='$OPENCLAW_GATEWAY_TOKEN' && node dist/index.js config get agents.defaults.model.primary' 2>/dev/null | tr -d '\r')
        
        if [[ "$CURRENT_MODEL" == *"deepseek"* ]] || [[ "$CURRENT_MODEL" == *"14b"* ]]; then
            echo -e "${YELLOW}⚠️  Warning: $CURRENT_MODEL may be slow on M2 Mac${NC}"
            echo -e "${YELLOW}   First response may take 30-60 seconds while model loads${NC}"
            echo ""
        fi
        
        # Build command - run directly in gateway container
        # Use localhost since we're inside the gateway container
        CMD="export OPENCLAW_GATEWAY_URL=http://localhost:18789 && export OPENCLAW_GATEWAY_TOKEN=$OPENCLAW_GATEWAY_TOKEN && node dist/index.js agent -m \"$MESSAGE\" --agent \"$AGENT\""
        if [ -n "$MODEL" ]; then
            CMD="$CMD --model \"$MODEL\""
        fi
        
        echo -e "${YELLOW}Running agent...${NC}"
        docker exec \
            openclaw-gateway \
            bash -c "$CMD"
        ;;
    
    "doctor")
        check_gateway
        ensure_cli
        docker compose -f "$COMPOSE_FILE" exec \
            -e OPENCLAW_GATEWAY_TOKEN="$OPENCLAW_GATEWAY_TOKEN" \
            openclaw-cli \
            node dist/index.js doctor \
            --url "ws://openclaw-gateway:18789" \
            --token "$OPENCLAW_GATEWAY_TOKEN"
        ;;
    
    "devices")
        check_gateway
        echo -e "${GREEN}Listing devices (from gateway container)...${NC}"
        # Run directly in gateway container - uses local fallback when pairing required
        docker compose -f "$COMPOSE_FILE" exec \
            openclaw-gateway \
            node dist/index.js devices list
        ;;
    
    "approve")
        check_gateway
        echo -e "${YELLOW}Approving pending devices...${NC}"
        
        # Approve all pending devices one by one
        # Uses local fallback in gateway container (works even with pairing required)
        while true; do
            # Try to approve latest device
            if docker compose -f "$COMPOSE_FILE" exec \
                openclaw-gateway \
                node dist/index.js devices approve 2>&1 | grep -q "Approved"; then
                echo -e "${GREEN}✓ Approved one device${NC}"
                # Check if there are more
                sleep 1
            else
                echo -e "${GREEN}✓ No more pending devices${NC}"
                break
            fi
        done
        
        echo ""
        echo -e "${YELLOW}Current device status:${NC}"
        docker compose -f "$COMPOSE_FILE" exec \
            openclaw-gateway \
            node dist/index.js devices list
        ;;
    
    "approve-device")
        if [ -z "${2:-}" ]; then
            echo -e "${RED}Error: Request ID required${NC}"
            echo "Usage: claw approve-device <REQUEST_ID>"
            echo ""
            echo -e "${YELLOW}List pending devices:${NC}"
            echo "  claw devices"
            exit 1
        fi
        check_gateway
        echo -e "${GREEN}Approving device $2...${NC}"
        docker compose -f "$COMPOSE_FILE" exec \
            openclaw-gateway \
            node dist/index.js devices approve "$2"
        ;;
    
    "ui"|"web"|"browser")
        check_gateway
        url="http://localhost:18789?token=$OPENCLAW_GATEWAY_TOKEN"
        echo -e "${GREEN}Opening OpenClaw Control UI...${NC}"
        echo -e "${BLUE}$url${NC}"
        
        if command -v open >/dev/null 2>&1; then
            open "$url"
        elif command -v xdg-open >/dev/null 2>&1; then
            xdg-open "$url"
        else
            echo "$url"
        fi
        ;;
    
    "url")
        echo "http://localhost:18789?token=$OPENCLAW_GATEWAY_TOKEN"
        ;;
    
    "token")
        echo -e "${GREEN}Gateway Token:${NC}"
        echo "$OPENCLAW_GATEWAY_TOKEN"
        ;;
    
    "health")
        if curl -s http://localhost:18789 > /dev/null 2>&1; then
            echo -e "${GREEN}✓ Gateway is responding on port 18789${NC}"
            echo "WebSocket: ws://localhost:18789"
            echo "Control UI: http://localhost:18789"
        else
            echo -e "${RED}✗ Gateway not responding${NC}"
            exit 1
        fi
        ;;
    
    "update")
        echo -e "${YELLOW}Updating OpenClaw...${NC}"
        docker compose -f "$COMPOSE_FILE" pull
        echo -e "${GREEN}✓ Images updated${NC}"
        echo -e "${YELLOW}Restarting...${NC}"
        # Use docker compose restart directly instead of calling claw recursively
        docker compose -f "$COMPOSE_FILE" restart openclaw-gateway
        sleep 3
        echo -e "${GREEN}✓ Gateway restarted${NC}"
        echo -e "${BLUE}Run 'claw health' to verify${NC}"
        ;;
    
    "fix-origins")
        echo -e "${YELLOW}Setting Control UI allowed origins...${NC}"
        ensure_cli
        docker compose -f "$COMPOSE_FILE" exec \
            openclaw-cli \
            node dist/index.js config set gateway.controlUi.allowedOrigins '["http://localhost:18789","http://127.0.0.1:18789"]' --strict-json
        echo -e "${GREEN}✓ Origins updated. Run 'claw restart' to apply.${NC}"
        ;;
    
    "regenerate-token")
        NEW_TOKEN=$(openssl rand -hex 32)
        echo -e "${GREEN}New token generated:${NC}"
        echo "OPENCLAW_GATEWAY_TOKEN=$NEW_TOKEN"
        echo ""
        echo -e "${YELLOW}1. Update $ENV_FILE${NC}"
        echo -e "${YELLOW}2. Run: claw restart${NC}"
        ;;
    "fix-ollama-auth")
        echo -e "${YELLOW}Creating Ollama auth profile...${NC}"
        docker exec openclaw-gateway bash -c '
            mkdir -p /home/node/.openclaw/agents/main/agent
            cat > /home/node/.openclaw/agents/main/agent/auth-profiles.json << EOF
            {
            "ollama:local": {
                "type": "token",
                "provider": "ollama",
                "token": "ollama-local"
            }
            }
            EOF
            chown -R node:node /home/node/.openclaw/agents'
        echo -e "${GREEN}✓ Ollama auth profile created${NC}"
        echo -e "${YELLOW}You can now use Ollama models. Try:${NC}"
        echo "  claw agent -p 'Hello'"
        ;;
    "agent-switch"|"switch-agent")
        check_gateway
        ensure_cli
        
        # Get current agent
        CURRENT=$(docker compose -f "$COMPOSE_FILE" exec \
            -e OPENCLAW_GATEWAY_TOKEN="$OPENCLAW_GATEWAY_TOKEN" \
            openclaw-cli \
            bash -c 'export OPENCLAW_GATEWAY_URL=http://openclaw-gateway:18789 && node dist/index.js config get agents.defaults.model.primary' 2>/dev/null | tr -d '\r')
        
        # List available agents from config
        echo -e "${YELLOW}Available agents:${NC}"
        echo ""
        echo -e "  ${GREEN}1) qwen-14b${NC} - Qwen 2.5 Coder 14B (current default)"
        echo "     Model: ollama/qwen2.5-coder:14b-instruct-q4_K_M"
        echo ""
        echo "  2) qwen-7b-q4 - Qwen 2.5 Coder 7B Q4"
        echo "     Model: ollama/qwen2.5-coder:7b-instruct-q4_K_M"
        echo ""
        echo "  3) qwen-7b - Qwen 2.5 Coder 7B Full"
        echo "     Model: ollama/qwen2.5-coder:7b"
        echo ""
        echo -e "  ${GREEN}4) phi3${NC} - Phi-3 3.8B"
        echo "     Model: ollama/phi3:3.8b"
        echo ""
        echo -e "  ${GREEN}5) deepseek${NC} - DeepSeek Coder V2 16B"
        echo "     Model: ollama/deepseek-coder-v2:16b"
        echo ""
        
        echo -n "Enter number (1-5): "
        read -r selection
        
        case "$selection" in
            1)
                AGENT_ID="qwen-14b"
                MODEL="ollama/qwen2.5-coder:14b-instruct-q4_K_M"
                ;;
            2)
                AGENT_ID="qwen-7b-q4"
                MODEL="ollama/qwen2.5-coder:7b-instruct-q4_K_M"
                ;;
            3)
                AGENT_ID="qwen-7b"
                MODEL="ollama/qwen2.5-coder:7b"
                ;;
            4)
                AGENT_ID="phi3"
                MODEL="ollama/phi3:3.8b"
                ;;
            5)
                AGENT_ID="deepseek"
                MODEL="ollama/deepseek-coder-v2:16b"
                ;;
            *)
                echo -e "${RED}Invalid selection${NC}"
                exit 1
                ;;
        esac
        
        echo -e "${GREEN}Switching to agent: $AGENT_ID ($MODEL)${NC}"
        
        # Update default model to match agent's model
        docker compose -f "$COMPOSE_FILE" exec \
            -e OPENCLAW_GATEWAY_TOKEN="$OPENCLAW_GATEWAY_TOKEN" \
            openclaw-cli \
            bash -c "export OPENCLAW_GATEWAY_URL=http://openclaw-gateway:18789 && node dist/index.js config set agents.defaults.model.primary \"$MODEL\""
        
        echo -e "${YELLOW}Restarting gateway to apply...${NC}"
        docker compose -f "$COMPOSE_FILE" restart openclaw-gateway
        sleep 3
        
        if curl -s http://localhost:18789 > /dev/null 2>&1; then
            echo -e "${GREEN}✓ Agent switched to: $AGENT_ID${NC}"
            echo -e "${BLUE}Model: $MODEL${NC}"
        else
            echo -e "${RED}✗ Restart failed${NC}"
            exit 1
        fi
        ;;
    
    "help"|"-h"|"--help")
        cat << 'EOF'
OpenClaw Docker Wrapper - Autonomous Coding Agent

USAGE:
  claw [command] [options]

QUICK START:
  claw start          # Start services (auto-updates images)
  claw ui             # Open Control UI in browser
  claw agent -m "hi"  # Run your first agent

SYSTEM COMMANDS:
  start              Pull latest images and start gateway
  stop               Stop all services (gateway + CLI)
  restart            Restart gateway
  status             Show Docker container status
  logs               Follow gateway logs in real-time
  update             Update to latest OpenClaw image
  health             Check if gateway is responding

INTERACTIVE COMMANDS:
  shell              Open interactive CLI container (bash)
  ui                 Open Control UI in browser with token
  url                Print Control UI URL (with auth token)
  token              Display gateway authentication token

AGENT COMMANDS:
  agent -m "msg"     Run agent with message (uses default agent)
  agent -m "msg" --agent kimi     Use specific agent
  agent -m "msg" --model ollama/phi3:3.8b  # Override model
  agent-switch       Interactive agent selection with auto-restart
  model              Interactive model selection with auto-restart

DEVICE COMMANDS:
  devices            List pending and paired devices
  approve            Approve ALL pending devices at once
  approve-device ID  Approve specific device by Request ID

CONFIG COMMANDS:
  fix-origins        Set Control UI allowed origins (fixes UI access)
  fix-ollama-auth    Create Ollama authentication profile
  regenerate-token Generate new random gateway token
  doctor             Run health checks and diagnostics

AVAILABLE AGENTS:
  kimi          Kimi K2.5 Cloud (32K context, reasoning)
  minimax       MiniMax M2.5 Cloud (16K context, balanced)
  gpt-oss       GPT-OSS Cloud (16K context, general coding)
  qwen-14b      Qwen 2.5 Coder 14B Local (fast, balanced)
  qwen-7b       Qwen 2.5 Coder 7B Local (efficient)
  phi3          Phi-3 3.8B Local (ultra-fast, minimal RAM)

EXAMPLES:
  # Start and open UI
  claw start && claw ui

  # Run agent with default (kimi)
  claw agent -m "Write a Python script to fetch weather"

  # Switch to lightweight model for quick tasks
  claw model
  # Select 6) phi3

  # Use specific agent for reasoning
  claw agent -m "Explain this algorithm" --agent kimi

  # GitHub workflow: clone, modify, commit, push
  claw agent -m "Clone my-repo, add error handling, commit and push"

  # Debug with specific model
  claw agent -m "Fix this bug" --model ollama/qwen2.5-coder:7b

TROUBLESHOOTING:
  Pairing required?        claw approve
  Model not found?         claw fix-ollama-auth
  UI won't load?           claw fix-origins && claw restart
  Ollama timeout?          Ensure 'ollama serve' is running on Mac
  Slow responses?          Switch to phi3 or qwen-7b model

PORTS:
  18789  Gateway WebSocket API + Control UI (HTTP)
  18791  Browser control (internal, loopback only)

CONFIG:
  ~/.openclaw/openclaw.json          Main configuration
  ~/.openclaw/agents/main/agent/     Agent profiles and auth
  ~/openclaw-workspace/              Agent workspace (synced to GitHub)

ENV:
  OPENCLAW_GATEWAY_TOKEN    Required: Auth token (auto-generated)
  GITHUB_TOKEN              Optional: For GitHub operations
  BRAVE_API_KEY             Optional: For web search

DOCS:  https://docs.openclaw.ai
EOF
        ;;
    
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'claw help' for usage"
        exit 1
        ;;
esac